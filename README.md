# Laravel Exporter

A fluent, memory-efficient data export package for Laravel supporting CSV, Excel, and JSON formats with rich formatting capabilities.

## Features

- ðŸš€ **Fluent API** - Clean, chainable methods for building exports
- ðŸ’¾ **Memory Efficient** - Uses generators and chunking for large datasets
- ðŸ“Š **Multiple Formats** - CSV, Excel (XLSX/XML), and JSON support
- ðŸ”„ **Flexible Data Sources** - Works with Eloquent queries, Collections, and arrays
- ðŸŽ¯ **Column Types** - Amount, Date, Percentage, Quantity with proper formatting
- ðŸ’° **INR Locale Support** - Indian numbering system (12,34,567.00)
- ðŸŽ¨ **Conditional Coloring** - Green for positive, Red for negative amounts
- ðŸ“‹ **Report Headers** - Company name, title, date range, generated by
- âž• **Totals & Subtotals** - Automatic calculation of column totals
- ðŸ”§ **Customizable** - Transform rows, set headers, and configure format options
- ðŸ“¦ **Zero Dependencies** - Excel export works without external libraries (optional OpenSpout support)

## Installation

```bash
composer require yourvendor/laravel-exporter
```

The package will automatically register its service provider.

### Publish Configuration (Optional)

```bash
php artisan vendor:publish --tag=exporter-config
```

## Basic Usage

### Using the Facade

```php
use YourVendor\LaravelExporter\Facades\Exporter;

// Export users to CSV
Exporter::make()
    ->from(User::query())
    ->toFile(storage_path('app/exports/users.csv'));

// Export with specific columns
Exporter::make()
    ->columns(['id', 'name', 'email'])
    ->from(User::query())
    ->download('users.csv');
```

### Using the Class Directly

```php
use YourVendor\LaravelExporter\Exporter;

$exporter = Exporter::make()
    ->format('xlsx')
    ->columns(['id', 'name', 'email'])
    ->headers(['ID', 'Full Name', 'Email Address'])
    ->from(User::query())
    ->toFile(storage_path('app/exports/users.xlsx'));
```

## Data Sources

The exporter supports multiple data sources:

```php
// Eloquent Query Builder
Exporter::make()->from(User::query());
Exporter::make()->from(User::where('active', true));

// Collections
Exporter::make()->from(collect($data));

// Arrays
Exporter::make()->from($arrayOfData);

// LazyCollections (memory efficient)
Exporter::make()->from(User::lazy());
```

## Export Formats

### CSV Export

```php
Exporter::make()
    ->format('csv')
    ->options([
        'delimiter' => ',',
        'enclosure' => '"',
        'include_headers' => true,
        'add_bom' => true, // Excel compatibility
    ])
    ->from($data)
    ->toFile('export.csv');
```

### Excel Export

```php
Exporter::make()
    ->format('xlsx')
    ->options([
        'sheet_name' => 'Users',
        'include_headers' => true,
    ])
    ->from($data)
    ->toFile('export.xlsx');
```

> **Note:** For native XLSX support, install OpenSpout: `composer require openspout/openspout`
> Without OpenSpout, exports will use Excel-compatible XML format.

### Excel Export with Column Types (NEW!)

Define column types for proper formatting, INR locale support, and conditional coloring:

```php
use LaravelExporter\Facades\Exporter;

Exporter::make()
    ->format('xlsx')
    ->columns(fn($cols) => $cols
        ->string('order_number', 'Order #')
        ->date('order_date', 'Date')
        ->string('customer_name', 'Customer')
        ->amount('total_amount', 'Amount')      // Green for +ve, Red for -ve
        ->quantity('items_count', 'Items')
        ->percentage('discount', 'Discount %')
    )
    ->from(Order::query())
    ->download('orders.xlsx');
```

### Column Types Available

| Type | Method | Description | Excel Format |
|------|--------|-------------|--------------|
| String | `->string()` | Plain text | General |
| Integer | `->integer()` | Whole numbers | #,##0 |
| Amount | `->amount()` | Currency with conditional coloring | #,##,##0.00 (INR) |
| Amount Plain | `->amountPlain()` | Currency without coloring | #,##,##0.00 |
| Percentage | `->percentage()` | Percentage values | 0.00% |
| Date | `->date()` | Date values | DD-MMM-YYYY |
| DateTime | `->datetime()` | Date and time | DD-MMM-YYYY HH:MM:SS |
| Boolean | `->boolean()` | Yes/No values | General |
| Quantity | `->quantity()` | Numeric quantities | #,##,##0.00 |

### Report Headers (NEW!)

Add professional headers to your exports:

```php
use LaravelExporter\Support\ReportHeader;

Exporter::make()
    ->format('xlsx')
    ->header(fn($h) => $h
        ->company('Acme Corporation')
        ->title('Sales Report')
        ->subtitle('Monthly Summary')
        ->dateRange('01-Nov-2024', '30-Nov-2024')
        ->generatedBy('John Doe')
        ->generatedAt()
    )
    ->columns(fn($cols) => $cols
        ->string('invoice_no', 'Invoice #')
        ->amount('amount', 'Amount')
    )
    ->from($data)
    ->download('sales-report.xlsx');
```

### Totals Row (NEW!)

Automatically calculate and add totals:

```php
Exporter::make()
    ->format('xlsx')
    ->columns(fn($cols) => $cols
        ->string('product', 'Product')
        ->quantity('qty', 'Quantity')
        ->amount('price', 'Price')
        ->amount('total', 'Total')
    )
    ->withTotals(['qty', 'price', 'total'])  // Columns to sum
    ->totalsLabel('GRAND TOTAL')
    ->from($data)
    ->download('products.xlsx');
```

### Locale & Conditional Coloring (NEW!)

```php
Exporter::make()
    ->format('xlsx')
    ->locale('en_IN')                    // Indian numbering (12,34,567.00)
    ->conditionalColoring(true)          // Green/Red for +ve/-ve amounts
    ->columns(fn($cols) => $cols
        ->string('account', 'Account')
        ->amount('debit', 'Debit')
        ->amount('credit', 'Credit')
        ->amount('balance', 'Balance')
    )
    ->from($ledgerEntries)
    ->download('ledger.xlsx');
```

### JSON Export

```php
Exporter::make()
    ->format('json')
    ->options([
        'pretty_print' => true,
        'wrap_in_object' => true,
        'data_key' => 'users',
        'include_metadata' => true,
    ])
    ->from($data)
    ->toFile('export.json');
```

## Column Selection

### Simple Columns

```php
Exporter::make()
    ->columns(['id', 'name', 'email'])
    ->from(User::query());
```

### Column Aliases

```php
Exporter::make()
    ->columns([
        'User ID' => 'id',
        'Full Name' => 'name',
        'Email Address' => 'email',
    ])
    ->from(User::query());
```

### Nested Columns (Dot Notation)

```php
Exporter::make()
    ->columns([
        'id',
        'name',
        'department.name', // Access related model
    ])
    ->from(User::with('department'));
```

## Custom Headers

```php
Exporter::make()
    ->columns(['id', 'name', 'email'])
    ->headers(['User ID', 'Full Name', 'Email Address'])
    ->from(User::query());
```

## Row Transformation

Transform each row before export:

```php
Exporter::make()
    ->transformRow(function (array $row, $originalItem) {
        $row['name'] = strtoupper($row['name']);
        $row['status'] = $originalItem->isActive() ? 'Active' : 'Inactive';
        return $row;
    })
    ->from(User::query());
```

## Output Methods

### Save to File

```php
Exporter::make()
    ->from($data)
    ->toFile(storage_path('app/exports/data.csv'));
```

### Download Response

```php
return Exporter::make()
    ->from($data)
    ->download('data.csv');
```

### Stream Response (Memory Efficient)

```php
return Exporter::make()
    ->from($data)
    ->stream('data.csv');
```

### Get as String

```php
$content = Exporter::make()
    ->from($data)
    ->toString();
```

## Using the Exportable Trait

Add export functionality directly to your models:

```php
use YourVendor\LaravelExporter\Traits\Exportable;

class User extends Model
{
    use Exportable;

    // Optional: Define default exportable columns
    protected array $exportable = ['id', 'name', 'email'];
    
    // Optional: Define default headers
    protected array $exportHeaders = ['ID', 'Full Name', 'Email'];
}
```

Then use it like this:

```php
// Export with model defaults
User::query()->export()->toFile('users.csv');

// Export with custom columns
User::where('active', true)
    ->export(['id', 'name'])
    ->download('active-users.csv');

// Quick export all
User::exportAll('csv', storage_path('users.csv'));
```

## Controller Example

```php
use YourVendor\LaravelExporter\Facades\Exporter;

class ExportController extends Controller
{
    public function exportUsers(Request $request)
    {
        $format = $request->get('format', 'csv');
        
        return Exporter::make()
            ->format($format)
            ->columns(['id', 'name', 'email', 'created_at'])
            ->headers(['ID', 'Name', 'Email', 'Registered At'])
            ->from(User::query())
            ->download("users.{$format}");
    }
}
```

## Memory Optimization

For large datasets, the package automatically uses:

- **Generators** - Data is processed one row at a time
- **Lazy Collections** - Eloquent queries use `lazy()` for memory efficiency
- **Chunking** - Configure chunk size for optimal performance

```php
Exporter::make()
    ->chunkSize(500) // Process 500 rows at a time
    ->from(User::query())
    ->toFile('large-export.csv');
```

## Configuration

Publish the config file to customize defaults:

```php
// config/exporter.php
return [
    'default_format' => 'csv',
    'chunk_size' => 1000,
    
    'csv' => [
        'delimiter' => ',',
        'enclosure' => '"',
        'include_headers' => true,
        'add_bom' => true,
    ],
    
    'excel' => [
        'include_headers' => true,
        'sheet_name' => 'Sheet1',
    ],
    
    'json' => [
        'pretty_print' => false,
        'wrap_in_object' => false,
    ],
];
```

## Requirements

- PHP 8.1+
- Laravel 10.x or 11.x

## Optional Dependencies

- `openspout/openspout` - For native XLSX file support

## License

MIT License
