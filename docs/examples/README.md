# Real-World Examples

This section provides production-ready examples for common export and import scenarios.

## Table of Contents

1. [E-commerce Order Export](#e-commerce-order-export)
2. [Financial Report Export](#financial-report-export)
3. [Inventory Management](#inventory-management)
4. [User Data Export (GDPR)](#user-data-export-gdpr)
5. [Sales Analytics Dashboard](#sales-analytics-dashboard)
6. [Bulk Product Import](#bulk-product-import)
7. [Multi-Warehouse Inventory Import](#multi-warehouse-inventory-import)
8. [Scheduled Report Generation](#scheduled-report-generation)

---

## E-commerce Order Export

A comprehensive order export with customer details, line items, and payment information.

### OrdersExport.php

```php
<?php

namespace App\Exports;

use App\Models\Order;
use DataSuite\LaravelExporter\Concerns\FromQuery;
use DataSuite\LaravelExporter\Concerns\WithHeadings;
use DataSuite\LaravelExporter\Concerns\WithMapping;
use DataSuite\LaravelExporter\Concerns\WithColumnDefinitions;
use DataSuite\LaravelExporter\Concerns\WithReportHeader;
use DataSuite\LaravelExporter\Concerns\WithTotals;
use DataSuite\LaravelExporter\Concerns\WithConditionalColoring;
use DataSuite\LaravelExporter\Concerns\WithChunkReading;
use DataSuite\LaravelExporter\Support\ColumnCollection;
use DataSuite\LaravelExporter\Support\ReportHeader;

class OrdersExport implements 
    FromQuery,
    WithHeadings,
    WithMapping,
    WithColumnDefinitions,
    WithReportHeader,
    WithTotals,
    WithConditionalColoring,
    WithChunkReading
{
    public function __construct(
        protected ?string $status = null,
        protected ?string $startDate = null,
        protected ?string $endDate = null,
        protected ?int $customerId = null
    ) {}

    public function query()
    {
        return Order::query()
            ->with(['customer', 'items.product', 'payments'])
            ->when($this->status, fn($q) => $q->where('status', $this->status))
            ->when($this->startDate, fn($q) => $q->whereDate('created_at', '>=', $this->startDate))
            ->when($this->endDate, fn($q) => $q->whereDate('created_at', '<=', $this->endDate))
            ->when($this->customerId, fn($q) => $q->where('customer_id', $this->customerId))
            ->orderBy('created_at', 'desc');
    }

    public function headings(): array
    {
        return [
            'Order ID',
            'Order Date',
            'Customer Name',
            'Customer Email',
            'Items Count',
            'Subtotal',
            'Tax',
            'Shipping',
            'Discount',
            'Total',
            'Payment Method',
            'Payment Status',
            'Fulfillment Status',
        ];
    }

    public function map($order): array
    {
        return [
            $order->order_number,
            $order->created_at,
            $order->customer->full_name,
            $order->customer->email,
            $order->items->count(),
            $order->subtotal,
            $order->tax_amount,
            $order->shipping_amount,
            $order->discount_amount,
            $order->total,
            $order->payments->first()?->method ?? 'N/A',
            $order->payment_status,
            $order->fulfillment_status,
        ];
    }

    public function columnDefinitions(): ColumnCollection
    {
        return ColumnCollection::make()
            ->string('Order ID')
            ->datetime('Order Date')
            ->string('Customer Name')
            ->string('Customer Email')
            ->integer('Items Count')
            ->amount('Subtotal')
            ->amount('Tax')
            ->amount('Shipping')
            ->amount('Discount')
            ->amount('Total')
            ->string('Payment Method')
            ->string('Payment Status')
            ->string('Fulfillment Status');
    }

    public function reportHeader(): ReportHeader
    {
        $period = 'All Time';
        if ($this->startDate && $this->endDate) {
            $period = "{$this->startDate} to {$this->endDate}";
        }

        return ReportHeader::make()
            ->title('Orders Export Report')
            ->addInfo('Generated', now()->format('Y-m-d H:i:s'))
            ->addInfo('Period', $period)
            ->addInfo('Status Filter', $this->status ?? 'All')
            ->addInfo('Generated By', auth()->user()?->name ?? 'System');
    }

    public function totalColumns(): array
    {
        return ['Subtotal', 'Tax', 'Shipping', 'Discount', 'Total'];
    }

    public function conditionalColors(): array
    {
        return [
            'Payment Status' => [
                'paid' => '#28a745',
                'pending' => '#ffc107',
                'failed' => '#dc3545',
                'refunded' => '#6c757d',
            ],
            'Fulfillment Status' => [
                'fulfilled' => '#28a745',
                'partial' => '#17a2b8',
                'unfulfilled' => '#ffc107',
                'cancelled' => '#dc3545',
            ],
        ];
    }

    public function chunkSize(): int
    {
        return 1000;
    }
}
```

### Usage in Controller

```php
use App\Exports\OrdersExport;
use DataSuite\LaravelExporter\Facades\Excel;

class OrderController extends Controller
{
    public function export(Request $request)
    {
        $request->validate([
            'status' => 'nullable|in:pending,processing,completed,cancelled',
            'start_date' => 'nullable|date',
            'end_date' => 'nullable|date|after_or_equal:start_date',
            'format' => 'nullable|in:xlsx,csv',
        ]);

        $export = new OrdersExport(
            status: $request->status,
            startDate: $request->start_date,
            endDate: $request->end_date
        );

        $format = $request->input('format', 'xlsx');
        $filename = "orders-" . now()->format('Y-m-d-His') . ".{$format}";

        return Excel::download($export, $filename);
    }

    public function exportMy(Request $request)
    {
        $export = new OrdersExport(
            customerId: auth()->user()->customer->id,
            startDate: $request->start_date,
            endDate: $request->end_date
        );

        return Excel::download($export, 'my-orders.xlsx');
    }
}
```

---

## Financial Report Export

Monthly financial summary with multiple sections and calculations.

### MonthlyFinancialReport.php

```php
<?php

namespace App\Exports;

use App\Models\Transaction;
use App\Models\Invoice;
use App\Models\Expense;
use DataSuite\LaravelExporter\Concerns\WithMultipleSheets;
use DataSuite\LaravelExporter\Concerns\WithReportHeader;

class MonthlyFinancialReport implements WithMultipleSheets
{
    public function __construct(
        protected int $year,
        protected int $month
    ) {}

    public function sheets(): array
    {
        return [
            'Summary' => new FinancialSummarySheet($this->year, $this->month),
            'Revenue' => new RevenueSheet($this->year, $this->month),
            'Expenses' => new ExpensesSheet($this->year, $this->month),
            'Transactions' => new TransactionsSheet($this->year, $this->month),
        ];
    }
}

class FinancialSummarySheet implements 
    FromCollection,
    WithHeadings,
    WithColumnDefinitions,
    WithReportHeader
{
    public function __construct(
        protected int $year,
        protected int $month
    ) {}

    public function collection()
    {
        $startDate = Carbon::create($this->year, $this->month, 1)->startOfMonth();
        $endDate = $startDate->copy()->endOfMonth();

        $revenue = Invoice::whereBetween('date', [$startDate, $endDate])
            ->where('status', 'paid')
            ->sum('total');

        $expenses = Expense::whereBetween('date', [$startDate, $endDate])
            ->where('status', 'approved')
            ->sum('amount');

        $taxCollected = Invoice::whereBetween('date', [$startDate, $endDate])
            ->where('status', 'paid')
            ->sum('tax_amount');

        return collect([
            ['Total Revenue', $revenue],
            ['Total Expenses', $expenses],
            ['Gross Profit', $revenue - $expenses],
            ['Profit Margin', $revenue > 0 ? (($revenue - $expenses) / $revenue) * 100 : 0],
            ['Tax Collected', $taxCollected],
            ['Outstanding Invoices', Invoice::where('status', 'pending')->sum('total')],
            ['Overdue Invoices', Invoice::where('status', 'overdue')->sum('total')],
        ]);
    }

    public function headings(): array
    {
        return ['Metric', 'Value'];
    }

    public function columnDefinitions(): ColumnCollection
    {
        return ColumnCollection::make()
            ->string('Metric')
            ->amount('Value');
    }

    public function reportHeader(): ReportHeader
    {
        $monthName = Carbon::create($this->year, $this->month, 1)->format('F Y');
        
        return ReportHeader::make()
            ->title('Financial Summary')
            ->addInfo('Period', $monthName)
            ->addInfo('Generated', now()->format('Y-m-d H:i:s'));
    }
}

class RevenueSheet implements 
    FromQuery,
    WithHeadings,
    WithMapping,
    WithColumnDefinitions,
    WithTotals
{
    public function __construct(
        protected int $year,
        protected int $month
    ) {}

    public function query()
    {
        $startDate = Carbon::create($this->year, $this->month, 1)->startOfMonth();
        $endDate = $startDate->copy()->endOfMonth();

        return Invoice::with('customer')
            ->whereBetween('date', [$startDate, $endDate])
            ->where('status', 'paid')
            ->orderBy('date');
    }

    public function headings(): array
    {
        return [
            'Invoice #',
            'Date',
            'Customer',
            'Subtotal',
            'Tax',
            'Total',
            'Payment Date',
        ];
    }

    public function map($invoice): array
    {
        return [
            $invoice->number,
            $invoice->date,
            $invoice->customer->name,
            $invoice->subtotal,
            $invoice->tax_amount,
            $invoice->total,
            $invoice->paid_at,
        ];
    }

    public function columnDefinitions(): ColumnCollection
    {
        return ColumnCollection::make()
            ->string('Invoice #')
            ->date('Date')
            ->string('Customer')
            ->amount('Subtotal')
            ->amount('Tax')
            ->amount('Total')
            ->date('Payment Date');
    }

    public function totalColumns(): array
    {
        return ['Subtotal', 'Tax', 'Total'];
    }
}

class ExpensesSheet implements 
    FromQuery,
    WithHeadings,
    WithMapping,
    WithColumnDefinitions,
    WithTotals,
    WithConditionalColoring
{
    public function __construct(
        protected int $year,
        protected int $month
    ) {}

    public function query()
    {
        $startDate = Carbon::create($this->year, $this->month, 1)->startOfMonth();
        $endDate = $startDate->copy()->endOfMonth();

        return Expense::with(['category', 'vendor'])
            ->whereBetween('date', [$startDate, $endDate])
            ->orderBy('date');
    }

    public function headings(): array
    {
        return [
            'Date',
            'Category',
            'Vendor',
            'Description',
            'Amount',
            'Status',
        ];
    }

    public function map($expense): array
    {
        return [
            $expense->date,
            $expense->category->name,
            $expense->vendor?->name ?? 'N/A',
            $expense->description,
            $expense->amount,
            $expense->status,
        ];
    }

    public function columnDefinitions(): ColumnCollection
    {
        return ColumnCollection::make()
            ->date('Date')
            ->string('Category')
            ->string('Vendor')
            ->string('Description')
            ->amount('Amount')
            ->string('Status');
    }

    public function totalColumns(): array
    {
        return ['Amount'];
    }

    public function conditionalColors(): array
    {
        return [
            'Status' => [
                'approved' => '#28a745',
                'pending' => '#ffc107',
                'rejected' => '#dc3545',
            ],
        ];
    }
}
```

---

## Inventory Management

Real-time inventory export with stock levels and reorder alerts.

### InventoryExport.php

```php
<?php

namespace App\Exports;

use App\Models\Product;
use DataSuite\LaravelExporter\Concerns\FromQuery;
use DataSuite\LaravelExporter\Concerns\WithHeadings;
use DataSuite\LaravelExporter\Concerns\WithMapping;
use DataSuite\LaravelExporter\Concerns\WithColumnDefinitions;
use DataSuite\LaravelExporter\Concerns\WithReportHeader;
use DataSuite\LaravelExporter\Concerns\WithConditionalColoring;
use DataSuite\LaravelExporter\Concerns\WithTotals;
use DataSuite\LaravelExporter\Support\ColumnCollection;
use DataSuite\LaravelExporter\Support\ReportHeader;
use Illuminate\Database\Eloquent\Builder;

class InventoryExport implements 
    FromQuery,
    WithHeadings,
    WithMapping,
    WithColumnDefinitions,
    WithReportHeader,
    WithConditionalColoring,
    WithTotals
{
    public function __construct(
        protected ?string $warehouse = null,
        protected ?string $category = null,
        protected bool $lowStockOnly = false
    ) {}

    public function query(): Builder
    {
        return Product::query()
            ->with(['category', 'inventory', 'warehouse'])
            ->when($this->warehouse, fn($q) => $q->whereHas('warehouse', fn($w) => $w->where('code', $this->warehouse)))
            ->when($this->category, fn($q) => $q->whereHas('category', fn($c) => $c->where('slug', $this->category)))
            ->when($this->lowStockOnly, fn($q) => $q->whereColumn('inventory.quantity', '<=', 'products.reorder_point'))
            ->orderBy('sku');
    }

    public function headings(): array
    {
        return [
            'SKU',
            'Product Name',
            'Category',
            'Warehouse',
            'Current Stock',
            'Reserved',
            'Available',
            'Reorder Point',
            'Reorder Qty',
            'Unit Cost',
            'Stock Value',
            'Status',
        ];
    }

    public function map($product): array
    {
        $inventory = $product->inventory;
        $available = $inventory->quantity - $inventory->reserved;
        $stockValue = $inventory->quantity * $product->unit_cost;

        $status = match(true) {
            $inventory->quantity <= 0 => 'Out of Stock',
            $inventory->quantity <= $product->reorder_point => 'Low Stock',
            $inventory->quantity <= $product->reorder_point * 2 => 'Medium',
            default => 'In Stock',
        };

        return [
            $product->sku,
            $product->name,
            $product->category->name,
            $product->warehouse->name,
            $inventory->quantity,
            $inventory->reserved,
            $available,
            $product->reorder_point,
            $product->reorder_quantity,
            $product->unit_cost,
            $stockValue,
            $status,
        ];
    }

    public function columnDefinitions(): ColumnCollection
    {
        return ColumnCollection::make()
            ->string('SKU')
            ->string('Product Name')
            ->string('Category')
            ->string('Warehouse')
            ->integer('Current Stock')
            ->integer('Reserved')
            ->integer('Available')
            ->integer('Reorder Point')
            ->integer('Reorder Qty')
            ->amount('Unit Cost')
            ->amount('Stock Value')
            ->string('Status');
    }

    public function reportHeader(): ReportHeader
    {
        return ReportHeader::make()
            ->title('Inventory Report')
            ->addInfo('Generated', now()->format('Y-m-d H:i:s'))
            ->addInfo('Warehouse', $this->warehouse ?? 'All Warehouses')
            ->addInfo('Category', $this->category ?? 'All Categories')
            ->addInfo('Filter', $this->lowStockOnly ? 'Low Stock Only' : 'All Items');
    }

    public function conditionalColors(): array
    {
        return [
            'Status' => [
                'In Stock' => '#28a745',
                'Medium' => '#17a2b8',
                'Low Stock' => '#ffc107',
                'Out of Stock' => '#dc3545',
            ],
        ];
    }

    public function totalColumns(): array
    {
        return ['Current Stock', 'Reserved', 'Available', 'Stock Value'];
    }
}
```

---

## User Data Export (GDPR)

GDPR-compliant user data export with all personal information.

### GdprDataExport.php

```php
<?php

namespace App\Exports;

use App\Models\User;
use DataSuite\LaravelExporter\Concerns\WithMultipleSheets;
use Carbon\Carbon;

class GdprDataExport implements WithMultipleSheets
{
    public function __construct(
        protected User $user
    ) {}

    public function sheets(): array
    {
        return [
            'Personal Information' => new UserProfileSheet($this->user),
            'Orders' => new UserOrdersSheet($this->user),
            'Addresses' => new UserAddressesSheet($this->user),
            'Login History' => new UserLoginHistorySheet($this->user),
            'Preferences' => new UserPreferencesSheet($this->user),
            'Communications' => new UserCommunicationsSheet($this->user),
        ];
    }
}

class UserProfileSheet implements FromCollection, WithHeadings
{
    public function __construct(protected User $user) {}

    public function collection()
    {
        return collect([
            ['Field', 'Value'],
            ['User ID', $this->user->id],
            ['Name', $this->user->name],
            ['Email', $this->user->email],
            ['Phone', $this->user->phone],
            ['Date of Birth', $this->user->date_of_birth?->format('Y-m-d')],
            ['Account Created', $this->user->created_at->format('Y-m-d H:i:s')],
            ['Email Verified', $this->user->email_verified_at?->format('Y-m-d H:i:s') ?? 'Not verified'],
            ['Last Login', $this->user->last_login_at?->format('Y-m-d H:i:s')],
            ['Account Status', $this->user->status],
        ]);
    }

    public function headings(): array
    {
        return ['Field', 'Value'];
    }
}

class UserOrdersSheet implements FromQuery, WithHeadings, WithMapping
{
    public function __construct(protected User $user) {}

    public function query()
    {
        return $this->user->orders()->with('items')->orderByDesc('created_at');
    }

    public function headings(): array
    {
        return ['Order ID', 'Date', 'Total', 'Status', 'Items'];
    }

    public function map($order): array
    {
        return [
            $order->order_number,
            $order->created_at->format('Y-m-d H:i:s'),
            number_format($order->total, 2),
            $order->status,
            $order->items->pluck('product.name')->implode(', '),
        ];
    }
}

class UserAddressesSheet implements FromCollection, WithHeadings
{
    public function __construct(protected User $user) {}

    public function collection()
    {
        return $this->user->addresses->map(fn($address) => [
            $address->type,
            $address->name,
            $address->line1,
            $address->line2,
            $address->city,
            $address->state,
            $address->postal_code,
            $address->country,
            $address->is_default ? 'Yes' : 'No',
        ]);
    }

    public function headings(): array
    {
        return ['Type', 'Name', 'Address Line 1', 'Address Line 2', 'City', 'State', 'Postal Code', 'Country', 'Default'];
    }
}

class UserLoginHistorySheet implements FromQuery, WithHeadings, WithMapping
{
    public function __construct(protected User $user) {}

    public function query()
    {
        return $this->user->loginHistory()->orderByDesc('created_at')->limit(100);
    }

    public function headings(): array
    {
        return ['Date/Time', 'IP Address', 'User Agent', 'Location', 'Status'];
    }

    public function map($login): array
    {
        return [
            $login->created_at->format('Y-m-d H:i:s'),
            $login->ip_address,
            $login->user_agent,
            $login->location,
            $login->successful ? 'Success' : 'Failed',
        ];
    }
}
```

### Usage

```php
use App\Exports\GdprDataExport;
use DataSuite\LaravelExporter\Facades\Excel;

class UserController extends Controller
{
    public function downloadMyData(Request $request)
    {
        $user = $request->user();
        
        // Log the export for audit purposes
        activity()
            ->performedOn($user)
            ->log('GDPR data export requested');

        return Excel::download(
            new GdprDataExport($user),
            "my-data-{$user->id}-" . now()->format('Y-m-d') . ".xlsx"
        );
    }
}
```

---

## Sales Analytics Dashboard

Sales performance export with calculated metrics.

### SalesAnalyticsExport.php

```php
<?php

namespace App\Exports;

use App\Models\Order;
use App\Models\Product;
use DataSuite\LaravelExporter\Facades\Exporter;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;

class SalesAnalyticsExport
{
    public function __construct(
        protected string $startDate,
        protected string $endDate,
        protected ?int $categoryId = null
    ) {}

    public function generate()
    {
        return Exporter::make()
            ->data($this->getData())
            ->columns(function ($col) {
                $col->string('Metric');
                $col->string('Period');
                $col->integer('Orders');
                $col->integer('Units Sold');
                $col->amount('Revenue');
                $col->amount('Avg Order Value');
                $col->percentage('Growth');
            })
            ->header('title', 'Sales Analytics Report')
            ->header('info', 'Period', "{$this->startDate} to {$this->endDate}")
            ->header('info', 'Generated', now()->format('Y-m-d H:i:s'))
            ->totals(['Orders', 'Units Sold', 'Revenue'])
            ->conditionalColors([
                'Growth' => [
                    fn($v) => $v > 10 => '#28a745',
                    fn($v) => $v >= 0 => '#17a2b8',
                    fn($v) => $v < 0 => '#dc3545',
                ],
            ])
            ->filename('sales-analytics-' . now()->format('Y-m-d'))
            ->download();
    }

    protected function getData(): Collection
    {
        $currentPeriod = $this->getMetrics($this->startDate, $this->endDate);
        
        // Calculate previous period for comparison
        $days = Carbon::parse($this->startDate)->diffInDays($this->endDate);
        $previousStart = Carbon::parse($this->startDate)->subDays($days + 1)->format('Y-m-d');
        $previousEnd = Carbon::parse($this->startDate)->subDay()->format('Y-m-d');
        $previousPeriod = $this->getMetrics($previousStart, $previousEnd);

        return collect([
            [
                'Metric' => 'Daily Average',
                'Period' => 'Current',
                'Orders' => round($currentPeriod['orders'] / max($days, 1)),
                'Units Sold' => round($currentPeriod['units'] / max($days, 1)),
                'Revenue' => $currentPeriod['revenue'] / max($days, 1),
                'Avg Order Value' => $currentPeriod['aov'],
                'Growth' => $this->calculateGrowth($currentPeriod['revenue'], $previousPeriod['revenue']),
            ],
            [
                'Metric' => 'Weekly Average',
                'Period' => 'Current',
                'Orders' => round($currentPeriod['orders'] / max($days / 7, 1)),
                'Units Sold' => round($currentPeriod['units'] / max($days / 7, 1)),
                'Revenue' => $currentPeriod['revenue'] / max($days / 7, 1),
                'Avg Order Value' => $currentPeriod['aov'],
                'Growth' => $this->calculateGrowth($currentPeriod['revenue'], $previousPeriod['revenue']),
            ],
            [
                'Metric' => 'Total',
                'Period' => 'Current',
                'Orders' => $currentPeriod['orders'],
                'Units Sold' => $currentPeriod['units'],
                'Revenue' => $currentPeriod['revenue'],
                'Avg Order Value' => $currentPeriod['aov'],
                'Growth' => $this->calculateGrowth($currentPeriod['revenue'], $previousPeriod['revenue']),
            ],
            [
                'Metric' => 'Total',
                'Period' => 'Previous',
                'Orders' => $previousPeriod['orders'],
                'Units Sold' => $previousPeriod['units'],
                'Revenue' => $previousPeriod['revenue'],
                'Avg Order Value' => $previousPeriod['aov'],
                'Growth' => 0,
            ],
        ]);
    }

    protected function getMetrics(string $startDate, string $endDate): array
    {
        $query = Order::query()
            ->whereBetween('created_at', [$startDate, $endDate])
            ->where('status', 'completed');

        if ($this->categoryId) {
            $query->whereHas('items.product', fn($q) => $q->where('category_id', $this->categoryId));
        }

        $orders = $query->count();
        $revenue = $query->sum('total');
        $units = $query->withSum('items', 'quantity')->get()->sum('items_sum_quantity');

        return [
            'orders' => $orders,
            'revenue' => $revenue,
            'units' => $units,
            'aov' => $orders > 0 ? $revenue / $orders : 0,
        ];
    }

    protected function calculateGrowth(float $current, float $previous): float
    {
        if ($previous == 0) {
            return $current > 0 ? 100 : 0;
        }
        return (($current - $previous) / $previous) * 100;
    }
}
```

---

## Bulk Product Import

Import products with validation and error handling.

### ProductsImport.php

```php
<?php

namespace App\Imports;

use App\Models\Product;
use App\Models\Category;
use DataSuite\LaravelExporter\Concerns\ToModel;
use DataSuite\LaravelExporter\Concerns\WithHeadingRow;
use DataSuite\LaravelExporter\Concerns\WithValidation;
use DataSuite\LaravelExporter\Concerns\SkipsOnError;
use DataSuite\LaravelExporter\Concerns\SkipsOnFailure;
use DataSuite\LaravelExporter\Concerns\WithBatchInserts;
use DataSuite\LaravelExporter\Concerns\WithChunkReading;
use DataSuite\LaravelExporter\Concerns\SkipsEmptyRows;
use DataSuite\LaravelExporter\Concerns\WithEvents;
use DataSuite\LaravelExporter\Concerns\RemembersRowNumber;
use Illuminate\Validation\Rule;
use Illuminate\Support\Str;

class ProductsImport implements 
    ToModel,
    WithHeadingRow,
    WithValidation,
    SkipsOnError,
    SkipsOnFailure,
    WithBatchInserts,
    WithChunkReading,
    SkipsEmptyRows,
    WithEvents,
    RemembersRowNumber
{
    use \DataSuite\LaravelExporter\Concerns\Importable;
    use \DataSuite\LaravelExporter\Concerns\RegistersEventListeners;

    protected array $errors = [];
    protected array $failures = [];
    protected int $importedCount = 0;

    public function model(array $row): ?Product
    {
        $category = Category::firstOrCreate(
            ['slug' => Str::slug($row['category'])],
            ['name' => $row['category']]
        );

        $this->importedCount++;

        return new Product([
            'sku' => $row['sku'],
            'name' => $row['name'],
            'description' => $row['description'] ?? null,
            'category_id' => $category->id,
            'price' => $row['price'],
            'cost' => $row['cost'] ?? 0,
            'quantity' => $row['quantity'] ?? 0,
            'reorder_point' => $row['reorder_point'] ?? 10,
            'weight' => $row['weight'] ?? null,
            'is_active' => $this->parseBoolean($row['active'] ?? true),
        ]);
    }

    public function rules(): array
    {
        return [
            'sku' => ['required', 'string', 'max:50', Rule::unique('products', 'sku')],
            'name' => ['required', 'string', 'max:255'],
            'category' => ['required', 'string', 'max:100'],
            'price' => ['required', 'numeric', 'min:0'],
            'cost' => ['nullable', 'numeric', 'min:0'],
            'quantity' => ['nullable', 'integer', 'min:0'],
            'reorder_point' => ['nullable', 'integer', 'min:0'],
            'weight' => ['nullable', 'numeric', 'min:0'],
            'active' => ['nullable'],
            'description' => ['nullable', 'string'],
        ];
    }

    public function customValidationMessages(): array
    {
        return [
            'sku.required' => 'SKU is required at row :attribute',
            'sku.unique' => 'SKU :input already exists at row :attribute',
            'price.required' => 'Price is required at row :attribute',
            'price.min' => 'Price must be positive at row :attribute',
        ];
    }

    public function customValidationAttributes(): array
    {
        return [
            'sku' => 'SKU',
            'name' => 'Product Name',
            'category' => 'Category',
            'price' => 'Price',
        ];
    }

    public function batchSize(): int
    {
        return 500;
    }

    public function chunkSize(): int
    {
        return 1000;
    }

    public function onError(\Throwable $e)
    {
        $this->errors[] = [
            'row' => $this->getRowNumber(),
            'error' => $e->getMessage(),
        ];
    }

    public function onFailure(\DataSuite\LaravelExporter\Validation\Failure ...$failures)
    {
        foreach ($failures as $failure) {
            $this->failures[] = [
                'row' => $failure->row(),
                'attribute' => $failure->attribute(),
                'errors' => $failure->errors(),
                'values' => $failure->values(),
            ];
        }
    }

    public function registerEvents(): array
    {
        return [
            BeforeImport::class => function(BeforeImport $event) {
                // Log import start
                Log::info('Product import started');
            },
            AfterImport::class => function(AfterImport $event) {
                // Log import completion
                Log::info('Product import completed', [
                    'imported' => $this->importedCount,
                    'errors' => count($this->errors),
                    'failures' => count($this->failures),
                ]);
            },
        ];
    }

    public function getErrors(): array
    {
        return $this->errors;
    }

    public function getFailures(): array
    {
        return $this->failures;
    }

    public function getImportedCount(): int
    {
        return $this->importedCount;
    }

    protected function parseBoolean($value): bool
    {
        if (is_bool($value)) {
            return $value;
        }
        
        return in_array(strtolower((string) $value), ['yes', 'true', '1', 'active', 'enabled']);
    }
}
```

### Controller with Progress Tracking

```php
use App\Imports\ProductsImport;
use DataSuite\LaravelExporter\Facades\Excel;
use Illuminate\Http\Request;

class ProductImportController extends Controller
{
    public function import(Request $request)
    {
        $request->validate([
            'file' => 'required|file|mimes:xlsx,csv|max:10240',
        ]);

        $import = new ProductsImport();

        try {
            Excel::import($import, $request->file('file'));

            $result = [
                'success' => true,
                'imported' => $import->getImportedCount(),
                'errors' => $import->getErrors(),
                'failures' => $import->getFailures(),
            ];

            if (count($import->getFailures()) > 0) {
                return response()->json([
                    ...$result,
                    'message' => "Import completed with {$import->getImportedCount()} products imported and " . count($import->getFailures()) . " validation failures.",
                ], 200);
            }

            return response()->json([
                ...$result,
                'message' => "Successfully imported {$import->getImportedCount()} products.",
            ], 200);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Import failed: ' . $e->getMessage(),
            ], 500);
        }
    }

    public function downloadTemplate()
    {
        return Exporter::make()
            ->data(collect([
                [
                    'sku' => 'PROD-001',
                    'name' => 'Sample Product',
                    'description' => 'Product description here',
                    'category' => 'Electronics',
                    'price' => 99.99,
                    'cost' => 50.00,
                    'quantity' => 100,
                    'reorder_point' => 10,
                    'weight' => 1.5,
                    'active' => 'yes',
                ],
            ]))
            ->filename('products-import-template')
            ->download();
    }
}
```

---

## Multi-Warehouse Inventory Import

Import inventory data across multiple warehouses with location validation.

### InventoryImport.php

```php
<?php

namespace App\Imports;

use App\Models\Product;
use App\Models\Warehouse;
use App\Models\Inventory;
use DataSuite\LaravelExporter\Concerns\ToCollection;
use DataSuite\LaravelExporter\Concerns\WithHeadingRow;
use DataSuite\LaravelExporter\Concerns\WithValidation;
use DataSuite\LaravelExporter\Concerns\WithChunkReading;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\DB;

class InventoryImport implements 
    ToCollection,
    WithHeadingRow,
    WithValidation,
    WithChunkReading
{
    protected array $results = [];
    protected array $warehouseCache = [];
    protected array $productCache = [];

    public function collection(Collection $rows)
    {
        DB::transaction(function () use ($rows) {
            foreach ($rows as $index => $row) {
                try {
                    $product = $this->findProduct($row['sku']);
                    $warehouse = $this->findWarehouse($row['warehouse_code']);

                    if (!$product) {
                        $this->results[] = [
                            'row' => $index + 2,
                            'status' => 'error',
                            'message' => "Product not found: {$row['sku']}",
                        ];
                        continue;
                    }

                    if (!$warehouse) {
                        $this->results[] = [
                            'row' => $index + 2,
                            'status' => 'error',
                            'message' => "Warehouse not found: {$row['warehouse_code']}",
                        ];
                        continue;
                    }

                    $inventory = Inventory::updateOrCreate(
                        [
                            'product_id' => $product->id,
                            'warehouse_id' => $warehouse->id,
                        ],
                        [
                            'quantity' => $row['quantity'],
                            'location' => $row['location'] ?? null,
                            'bin' => $row['bin'] ?? null,
                            'lot_number' => $row['lot_number'] ?? null,
                            'expiry_date' => $row['expiry_date'] ?? null,
                        ]
                    );

                    $this->results[] = [
                        'row' => $index + 2,
                        'status' => $inventory->wasRecentlyCreated ? 'created' : 'updated',
                        'sku' => $row['sku'],
                        'warehouse' => $row['warehouse_code'],
                        'quantity' => $row['quantity'],
                    ];

                } catch (\Exception $e) {
                    $this->results[] = [
                        'row' => $index + 2,
                        'status' => 'error',
                        'message' => $e->getMessage(),
                    ];
                }
            }
        });
    }

    public function rules(): array
    {
        return [
            'sku' => 'required|string',
            'warehouse_code' => 'required|string',
            'quantity' => 'required|integer|min:0',
            'location' => 'nullable|string|max:50',
            'bin' => 'nullable|string|max:20',
            'lot_number' => 'nullable|string|max:50',
            'expiry_date' => 'nullable|date',
        ];
    }

    public function chunkSize(): int
    {
        return 500;
    }

    protected function findProduct(string $sku): ?Product
    {
        if (!isset($this->productCache[$sku])) {
            $this->productCache[$sku] = Product::where('sku', $sku)->first();
        }
        return $this->productCache[$sku];
    }

    protected function findWarehouse(string $code): ?Warehouse
    {
        if (!isset($this->warehouseCache[$code])) {
            $this->warehouseCache[$code] = Warehouse::where('code', $code)->first();
        }
        return $this->warehouseCache[$code];
    }

    public function getResults(): array
    {
        return $this->results;
    }

    public function getSummary(): array
    {
        $created = collect($this->results)->where('status', 'created')->count();
        $updated = collect($this->results)->where('status', 'updated')->count();
        $errors = collect($this->results)->where('status', 'error')->count();

        return [
            'total' => count($this->results),
            'created' => $created,
            'updated' => $updated,
            'errors' => $errors,
        ];
    }
}
```

---

## Scheduled Report Generation

Automated report generation with email delivery.

### GenerateDailyReportsCommand.php

```php
<?php

namespace App\Console\Commands;

use App\Exports\DailySalesExport;
use App\Exports\LowStockExport;
use App\Exports\PendingOrdersExport;
use App\Mail\DailyReportMail;
use DataSuite\LaravelExporter\Facades\Excel;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\Storage;
use Carbon\Carbon;

class GenerateDailyReportsCommand extends Command
{
    protected $signature = 'reports:daily 
                            {--date= : The date to generate reports for (default: yesterday)}
                            {--email=* : Email addresses to send reports to}';

    protected $description = 'Generate and send daily reports';

    public function handle()
    {
        $date = $this->option('date') 
            ? Carbon::parse($this->option('date')) 
            : Carbon::yesterday();

        $emails = $this->option('email') ?: config('reports.daily.recipients', []);

        $this->info("Generating daily reports for {$date->format('Y-m-d')}...");

        $reports = [];

        // Generate Sales Report
        $this->line('Generating sales report...');
        $salesPath = "reports/{$date->format('Y/m')}/daily-sales-{$date->format('Y-m-d')}.xlsx";
        Excel::store(new DailySalesExport($date), $salesPath);
        $reports['sales'] = $salesPath;

        // Generate Low Stock Report
        $this->line('Generating low stock report...');
        $stockPath = "reports/{$date->format('Y/m')}/low-stock-{$date->format('Y-m-d')}.xlsx";
        Excel::store(new LowStockExport(), $stockPath);
        $reports['stock'] = $stockPath;

        // Generate Pending Orders Report
        $this->line('Generating pending orders report...');
        $ordersPath = "reports/{$date->format('Y/m')}/pending-orders-{$date->format('Y-m-d')}.xlsx";
        Excel::store(new PendingOrdersExport(), $ordersPath);
        $reports['orders'] = $ordersPath;

        // Send email with attachments
        if (!empty($emails)) {
            $this->line('Sending reports via email...');
            
            foreach ($emails as $email) {
                Mail::to($email)->send(new DailyReportMail($date, $reports));
            }

            $this->info('Reports sent to: ' . implode(', ', $emails));
        }

        // Cleanup old reports (keep 30 days)
        $this->cleanupOldReports();

        $this->info('Daily reports generated successfully!');

        return Command::SUCCESS;
    }

    protected function cleanupOldReports()
    {
        $cutoffDate = Carbon::now()->subDays(30);
        
        $files = Storage::files('reports', true);
        
        foreach ($files as $file) {
            $lastModified = Carbon::createFromTimestamp(Storage::lastModified($file));
            
            if ($lastModified->lt($cutoffDate)) {
                Storage::delete($file);
                $this->line("Deleted old report: {$file}");
            }
        }
    }
}
```

### DailyReportMail.php

```php
<?php

namespace App\Mail;

use Illuminate\Bus\Queueable;
use Illuminate\Mail\Mailable;
use Illuminate\Mail\Mailables\Attachment;
use Illuminate\Mail\Mailables\Content;
use Illuminate\Mail\Mailables\Envelope;
use Illuminate\Queue\SerializesModels;
use Illuminate\Support\Facades\Storage;
use Carbon\Carbon;

class DailyReportMail extends Mailable
{
    use Queueable, SerializesModels;

    public function __construct(
        public Carbon $date,
        public array $reports
    ) {}

    public function envelope(): Envelope
    {
        return new Envelope(
            subject: "Daily Reports - {$this->date->format('F j, Y')}",
        );
    }

    public function content(): Content
    {
        return new Content(
            view: 'emails.daily-reports',
            with: [
                'date' => $this->date,
                'reportCount' => count($this->reports),
            ],
        );
    }

    public function attachments(): array
    {
        return collect($this->reports)
            ->map(fn($path) => Attachment::fromStorage($path))
            ->toArray();
    }
}
```

### Schedule Registration

```php
// routes/console.php or app/Console/Kernel.php

use Illuminate\Support\Facades\Schedule;

Schedule::command('reports:daily')
    ->dailyAt('06:00')
    ->emailOutputOnFailure(config('reports.admin_email'))
    ->runInBackground();

Schedule::command('reports:weekly')
    ->weeklyOn(1, '07:00')  // Monday at 7 AM
    ->runInBackground();

Schedule::command('reports:monthly')
    ->monthlyOn(1, '08:00')  // 1st of month at 8 AM
    ->runInBackground();
```

---

## Quick Reference: Common Patterns

### Download vs Store

```php
// Direct download
return Excel::download(new OrdersExport(), 'orders.xlsx');

// Store to disk
Excel::store(new OrdersExport(), 'reports/orders.xlsx', 's3');

// Queue for large files
Excel::queue(new OrdersExport(), 'reports/orders.xlsx');
```

### Fluent API Quick Export

```php
use DataSuite\LaravelExporter\Facades\Exporter;

// Simplest export
return Exporter::make()
    ->data(User::all())
    ->filename('users')
    ->download();

// With all options
return Exporter::make()
    ->query(Order::with('customer'))
    ->columns(fn($col) => $col
        ->string('Order #')
        ->date('Date')
        ->amount('Total'))
    ->map(fn($order) => [
        $order->number,
        $order->created_at,
        $order->total,
    ])
    ->header('title', 'Orders Report')
    ->totals(['Total'])
    ->format('xlsx')
    ->download();
```

### Import with Error Collection

```php
$import = new ProductsImport();
Excel::import($import, $file);

$result = $import->toResult();

if ($result->hasFailures()) {
    foreach ($result->failures() as $failure) {
        echo "Row {$failure->row()}: " . implode(', ', $failure->errors());
    }
}

echo "Imported: " . $result->successCount();
```

---

[‚Üê Back to Documentation](../INDEX.md)
